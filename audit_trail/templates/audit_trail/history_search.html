{% extends "base.html" %}
{% load static %}

{% block title %}Audit History Search{% endblock %}

{% block content %}
<section class="bg-slate-950 py-12">
    <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 space-y-10">

        <!-- Header -->
        <header
            class="rounded-3xl bg-gradient-to-r from-slate-900 via-slate-800 to-indigo-900 p-8 text-white shadow-2xl shadow-indigo-900/40">
            <p class="text-xs font-semibold uppercase tracking-[0.25em] text-indigo-200">
                Forensics Toolkit
            </p>
            <h1 class="mt-3 text-3xl font-semibold">
                Audit History Search
            </h1>
            <p class="mt-2 text-sm text-slate-200">
                Run precise lookups across archived events by model, record identifier, or actor metadata.
            </p>
        </header>

        <!-- Search Panel -->
        <div class="rounded-3xl bg-slate-900/80 p-8 shadow-2xl shadow-slate-900/60 ring-1 ring-white/10">
            <form method="get" class="space-y-8">

                {% if form.non_field_errors %}
                <div class="rounded-2xl border border-red-400/40 bg-red-500/10 px-4 py-3 text-sm text-red-200">
                    {{ form.non_field_errors.as_ul }}
                </div>
                {% endif %}

                <!-- Search Fields Grid -->
                <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-4">
                    <!-- Model -->
                    <div class="space-y-2">
                        <label for="id_model" class="text-sm font-semibold text-slate-200">Model label</label>
                        <div class="rounded-xl border border-white/10 bg-slate-950/60 px-3 py-2 shadow-inner">
                            {{ form.model }}
                        </div>
                        <p class="text-xs text-slate-400">Example: <code>policies.Policy</code></p>
                    </div>

                    <!-- Object ID -->
                    <div class="space-y-2">
                        <label for="id_object_id" class="text-sm font-semibold text-slate-200">Object ID</label>
                        <div class="rounded-xl border border-white/10 bg-slate-950/60 px-3 py-2 shadow-inner">
                            {{ form.object_id }}
                        </div>
                        <p class="text-xs text-slate-400">Combine with model for a single record.</p>
                    </div>

                    <!-- User ID -->
                    <div class="space-y-2">
                        <label for="id_user_id" class="text-sm font-semibold text-slate-200">User ID</label>
                        <div class="rounded-xl border border-white/10 bg-slate-950/60 px-3 py-2 shadow-inner">
                            {{ form.user_id }}
                        </div>
                        <p class="text-xs text-slate-400">Filter events by specific actor.</p>
                    </div>

                    <!-- Limit -->
                    <div class="space-y-2">
                        <label for="id_limit" class="text-sm font-semibold text-slate-200">Results per page</label>
                        <div class="rounded-xl border border-white/10 bg-slate-950/60 px-3 py-2 shadow-inner">
                            {{ form.limit }}
                        </div>
                        <p class="text-xs text-slate-400">Max 100 records.</p>
                    </div>
                </div>

                {{ form.cursor }}

                <!-- Search Actions -->
                <div class="flex flex-wrap items-center gap-4">
                    <button type="submit"
                        class="inline-flex items-center justify-center rounded-full bg-indigo-500 px-6 py-2 text-sm font-semibold text-white shadow hover:bg-indigo-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-400">
                        Search
                    </button>

                    {% if next_cursor %}
                    <button type="submit" name="cursor" value="{{ next_cursor }}"
                        class="inline-flex items-center justify-center rounded-full border border-white/20 px-6 py-2 text-sm font-semibold text-slate-100 hover:border-white/40">
                        Next Page
                    </button>
                    {% endif %}

                    {% if error_message %}
                    <span class="text-sm text-rose-300">{{ error_message }}</span>
                    {% endif %}
                </div>

            </form>
        </div>

        <!-- Results Panel -->
        <div class="rounded-3xl bg-slate-900/70 p-8 shadow-xl shadow-slate-950/40 ring-1 ring-white/5"
            id="history-results">

            {% if cards %}
            <!-- Results as cards -->
            <h2 class="text-xl font-semibold text-slate-100 mb-6">Results</h2>
            <div class="space-y-6">
                {% include "audit_trail/components/history_feed.html" with events=cards %}
            </div>

            {% else %}
            <div class="rounded-2xl border border-dashed border-white/20 px-6 py-10 text-center">
                <p class="text-base font-medium text-slate-100">No events to display yet.</p>
                <p class="mt-2 text-sm text-slate-400">Adjust your filters above and search again.</p>
            </div>
            {% endif %}
        </div>

    </div>
</section>
{% endblock %}
